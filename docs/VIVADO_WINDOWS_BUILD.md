# Building Bitstream on Windows with Vivado

## Overview
The LiteX SoC gateware is generated on Ubuntu (in the VirtualBox VM), then synthesized with Vivado on Windows. This document covers the Windows workflow.

## Prerequisites
- Vivado installed on Windows (any recent version; 2020.2 or later recommended)
- Shared folder mounted/accessible (e.g., VirtualBox shared folder)
- Gateware files copied from Ubuntu to shared folder (done automatically by `bash scripts/build_hw.sh` on Ubuntu)

## Step 1: Generate Gateware on Ubuntu
On the Ubuntu VM, run:
```bash
cd /home/yonatang/Final_Project/litex-nexys4ddr
bash scripts/build_hw.sh
```

This will:
1. Activate the Python venv
2. Generate LiteX gateware (Verilog, constraints, TCL script)
3. Copy everything to the shared folder at: `<SHARED_FOLDER>/nexys4ddr_build/`

**Output:**
```
=== Ready for Windows Vivado Build ===
Shared folder: /media/sf_shared/nexys4ddr_build
TCL script: digilent_nexys4ddr.tcl

On Windows, run this command (in PowerShell or CMD):
  cd "<shared_path>\nexys4ddr_build"
  vivado -mode batch -source digilent_nexys4ddr.tcl
```

## Step 2: Synthesize on Windows

### Option A: PowerShell (Recommended)
Open PowerShell on Windows and run:
```powershell
# Navigate to the shared gateware folder
cd "Z:\nexys4ddr_build"  # or your shared folder drive letter

# Run Vivado in batch mode
vivado -mode batch -source digilent_nexys4ddr.tcl
```

**Note:** Replace `Z:\` with your actual shared folder drive letter (commonly `Z:` for VirtualBox shared folders, but may vary).

### Option B: Command Prompt (CMD)
```cmd
cd Z:\nexys4ddr_build
vivado -mode batch -source digilent_nexys4ddr.tcl
```

### Option C: Windows batch script
Create a file `run_vivado.bat` in the shared folder:
```batch
@echo off
cd /d %~dp0
echo Running Vivado synthesis...
vivado -mode batch -source digilent_nexys4ddr.tcl
if %ERRORLEVEL% EQU 0 (
    echo Bitstream generation succeeded!
    dir *.bit
) else (
    echo Vivado failed with error code %ERRORLEVEL%
)
pause
```

Then double-click `run_vivado.bat`.

## Step 3: Locate the Generated Bitstream

After Vivado completes, the bitstream should be at:
```
Z:\nexys4ddr_build\nexys4ddr_vexriscv.bit
```

To verify:
```powershell
dir Z:\nexys4ddr_build\*.bit
```

Expected output:
```
    Directory: Z:\nexys4ddr_build

Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-a----         2/8/2026  3:00 PM      1234567 nexys4ddr_vexriscv.bit
```

## Step 4: Program the Board

Once you have the `.bit` file:

1. **In Vivado Hardware Manager (GUI):**
   - Open Vivado
   - Go to **Hardware Manager**
   - **Open Target → Auto Connect**
   - Right-click the device → **Program Device**
   - Select `nexys4ddr_vexriscv.bit`
   - Click **Program**

2. **Via TCL in Vivado:**
   ```tcl
   open_hw
   connect_hw_server
   open_hw_target
   current_hw_device [lindex [get_hw_devices] 0]
   set_property PROGRAM.FILE {Z:\nexys4ddr_build\nexys4ddr_vexriscv.bit} [current_hw_device]
   program_hw_devices [current_hw_device]
   close_hw_target
   ```

## Troubleshooting

### Vivado not found
Ensure Vivado is in your Windows `PATH`. Test with:
```powershell
vivado -version
```

If not found, add Vivado to PATH:
1. Open **Environment Variables** (Windows Start → "env")
2. Edit `PATH` and add `C:\Xilinx\Vivado\<version>\bin`
3. Restart PowerShell

### TCL script not found
Ensure you're in the correct folder:
```powershell
ls -Name *.tcl
```

Should output: `digilent_nexys4ddr.tcl`

### Shared folder not accessible
On Ubuntu, check where the shared folder is mounted:
```bash
df -h | grep sf_
mount | grep vboxsf
```

Then set the path before building:
```bash
export SHARED_OUT=/path/to/mounted/folder
bash scripts/build_hw.sh
```

## UART Connection

Once the bitstream is programmed to the board:

1. Connect the Nexys4 DDR USB UART port to your computer
2. Open a terminal program (e.g., PuTTY, minicom, screen)
3. Settings:
   - **Baud rate:** 115200
   - **Data bits:** 8
   - **Parity:** None
   - **Stop bits:** 1
   - **Flow control:** None
4. You should see a boot banner or prompt

## Notes
- The TCL script generated by LiteX handles all synthesis, place & route, and bitstream generation automatically
- The process is non-interactive; Vivado will exit when complete
- Check `vivado.log` in the build folder for detailed output if there are errors
